jQuery.trumbowyg={langs:{en:{viewHTML:"View HTML",undo:"Undo",redo:"Redo",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphasis",del:"Deleted",superscript:"Superscript",subscript:"Subscript",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image",link:"Link",createLink:"Insert link",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",horizontalRule:"Insert horizontal rule",removeformat:"Remove format",fullscreen:"Fullscreen",close:"Close",submit:"Confirm",reset:"Cancel",required:"Required",description:"Description",title:"Title",text:"Text",target:"Target"}},plugins:{},svgPath:null,hideButtonTexts:null},function(c,u,g,h){"use strict";h.fn.trumbowyg=function(e,t){var n="trumbowyg";if(e===Object(e)||!e)return this.each(function(){h(this).data(n)||h(this).data(n,new a(this,e))});if(1===this.length)try{var o=h(this).data(n);switch(e){case"execCmd":return o.execCmd(t.cmd,t.param,t.forceCss);case"openModal":return o.openModal(t.title,t.content);case"closeModal":return o.closeModal();case"openModalInsert":return o.openModalInsert(t.title,t.fields,t.callback);case"saveRange":return o.saveRange();case"getRange":return o.range;case"getRangeText":return o.getRangeText();case"restoreRange":return o.restoreRange();case"enable":return o.toggleDisable(!1);case"disable":return o.toggleDisable(!0);case"destroy":return o.destroy();case"empty":return o.empty();case"html":return o.html(t)}}catch(e){}return!1};var a=function(e,t){var o=this,n="trumbowyg-icons";o.doc=e.ownerDocument||g,o.$ta=h(e),o.$c=h(e),null!=(t=t||{}).lang||null!=h.trumbowyg.langs[t.lang]?o.lang=h.extend(!0,{},h.trumbowyg.langs.en,h.trumbowyg.langs[t.lang]):o.lang=h.trumbowyg.langs.en,o.hideButtonTexts=null!=h.trumbowyg.hideButtonTexts?h.trumbowyg.hideButtonTexts:t.hideButtonTexts;var a=null!=h.trumbowyg.svgPath?h.trumbowyg.svgPath:t.svgPath;if(o.hasSvg=!1!==a,o.svgPath=o.doc.querySelector("base")?u.location.href.split("#")[0]:"",0===h("#"+n,o.doc).length&&!1!==a){if(null==a)try{throw new Error}catch(e){var r=e.stack.split("\n");for(var i in r)if(r[i].match(/http[s]?:\/\//)){(a=r[Number(i)].match(/((http[s]?:\/\/.+\/)([^\/]+\.js))(\?.*)?:/)[1].split("/")).pop(),a=a.join("/")+"/ui/icons.svg";break}}var s=o.doc.createElement("div");s.id=n,o.doc.body.insertBefore(s,o.doc.body.childNodes[0]),h.ajax({async:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"xml",crossDomain:!0,url:a,data:null,beforeSend:null,complete:null,success:function(e){s.innerHTML=(new XMLSerializer).serializeToString(e.documentElement)}})}var l=o.lang.header,d=function(){return(u.chrome||u.Intl&&Intl.v8BreakIterator)&&"CSS"in u};o.btnsDef={viewHTML:{fn:"toggle"},undo:{isSupported:d,key:"Z"},redo:{isSupported:d,key:"Y"},p:{fn:"formatBlock"},blockquote:{fn:"formatBlock"},h1:{fn:"formatBlock",title:l+" 1"},h2:{fn:"formatBlock",title:l+" 2"},h3:{fn:"formatBlock",title:l+" 3"},h4:{fn:"formatBlock",title:l+" 4"},subscript:{tag:"sub"},superscript:{tag:"sup"},bold:{key:"B",tag:"b"},italic:{key:"I",tag:"i"},underline:{tag:"u"},strikethrough:{tag:"strike"},strong:{fn:"bold",key:"B"},em:{fn:"italic",key:"I"},del:{fn:"strikethrough"},createLink:{key:"K",tag:"a"},unlink:{},insertImage:{},justifyLeft:{tag:"left",forceCss:!0},justifyCenter:{tag:"center",forceCss:!0},justifyRight:{tag:"right",forceCss:!0},justifyFull:{tag:"justify",forceCss:!0},unorderedList:{fn:"insertUnorderedList",tag:"ul"},orderedList:{fn:"insertOrderedList",tag:"ol"},horizontalRule:{fn:"insertHorizontalRule"},removeformat:{},fullscreen:{class:"trumbowyg-not-disable"},close:{fn:"destroy",class:"trumbowyg-not-disable"},formatting:{dropdown:["p","blockquote","h1","h2","h3","h4"],ico:"p"},link:{dropdown:["createLink","unlink"]}},o.o=h.extend(!0,{},{lang:"en",fixedBtnPane:!1,fixedFullWidth:!1,autogrow:!1,autogrowOnEnter:!1,prefix:"trumbowyg-",semantic:!0,resetCss:!1,removeformatPasted:!1,tagsToRemove:[],btnsGrps:{design:["bold","italic","underline","strikethrough"],semantic:["strong","em","del"],justify:["justifyLeft","justifyCenter","justifyRight","justifyFull"],lists:["unorderedList","orderedList"]},btns:[["viewHTML"],["undo","redo"],["formatting"],"btnGrp-semantic",["superscript","subscript"],["link"],["insertImage"],"btnGrp-justify","btnGrp-lists",["horizontalRule"],["removeformat"],["fullscreen"]],btnsDef:{},inlineElementsSelector:"a,abbr,acronym,b,caption,cite,code,col,dfn,dir,dt,dd,em,font,hr,i,kbd,li,q,span,strikeout,strong,sub,sup,u",pasteHandlers:[],imgDblClickHandler:function(){var t=h(this),e=t.attr("src"),n="(Base64)";return 0===e.indexOf("data:image")&&(e=n),o.openModalInsert(o.lang.insertImage,{url:{label:"URL",value:e,required:!0},alt:{label:o.lang.description,value:t.attr("alt")}},function(e){return e.src!==n&&t.attr({src:e.src}),t.attr({alt:e.alt}),!0}),!1},plugins:{}},t),o.disabled=o.o.disabled||"TEXTAREA"===e.nodeName&&e.disabled,t.btns?o.o.btns=t.btns:o.o.semantic||(o.o.btns[4]="btnGrp-design"),h.each(o.o.btnsDef,function(e,t){o.addBtnDef(e,t)}),o.eventNamespace="trumbowyg-event",o.keys=[],o.tagToButton={},o.tagHandlers=[],o.pasteHandlers=[].concat(o.o.pasteHandlers),o.isIE=-1!==c.userAgent.indexOf("MSIE")||-1!==c.appVersion.indexOf("Trident/"),o.init()};a.prototype={init:function(){var e=this;e.height=e.$ta.height(),e.initPlugins();try{e.doc.execCommand("enableObjectResizing",!1,!1),e.doc.execCommand("defaultParagraphSeparator",!1,"p")}catch(e){}e.buildEditor(),e.buildBtnPane(),e.fixedBtnPaneEvents(),e.buildOverlay(),setTimeout(function(){e.disabled&&e.toggleDisable(!0),e.$c.trigger("tbwinit")})},addBtnDef:function(e,t){this.btnsDef[e]=t},buildEditor:function(){var o=this,t=o.o.prefix,e="";o.$box=h("<div/>",{class:t+"box "+t+"editor-visible "+t+o.o.lang+" trumbowyg"}),o.isTextarea=o.$ta.is("textarea"),o.isTextarea?(e=o.$ta.val(),o.$ed=h("<div/>"),o.$box.insertAfter(o.$ta).append(o.$ed,o.$ta)):(o.$ed=o.$ta,e=o.$ed.html(),o.$ta=h("<textarea/>",{name:o.$ta.attr("id"),height:o.height}).val(e),o.$box.insertAfter(o.$ed).append(o.$ta,o.$ed),o.syncCode()),o.$ta.addClass(t+"textarea").attr("tabindex",-1),o.$ed.addClass(t+"editor").attr({contenteditable:!0,dir:o.lang._dir||"ltr"}).html(e),o.o.tabindex&&o.$ed.attr("tabindex",o.o.tabindex),o.$c.is("[placeholder]")&&o.$ed.attr("placeholder",o.$c.attr("placeholder")),o.o.resetCss&&o.$ed.addClass(t+"reset-css"),o.o.autogrow||o.$ta.add(o.$ed).css({height:o.height}),o.semanticCode(),o.o.autogrowOnEnter&&o.$ed.addClass("autogrow-on-enter");var n,a=!1,r=!1,i=o.isIE?"keyup":"input";o.$ed.on("dblclick","img",o.o.imgDblClickHandler).on("keydown",function(e){if(e.ctrlKey&&!e.altKey){a=!0;var t=o.keys[String.fromCharCode(e.which).toUpperCase()];try{return o.execCmd(t.fn,t.param),!1}catch(e){}}}).on("compositionstart compositionupdate",function(){r=!0}).on(i+" compositionend",function(e){if("compositionend"===e.type)r=!1;else if(r)return;var t=e.which;37<=t&&t<=40||(!e.ctrlKey||89!==t&&90!==t?a||17===t?void 0===e.which&&o.semanticCode(!1,!1,!0):(o.semanticCode(!1,13===t),o.$c.trigger("tbwchange")):o.$c.trigger("tbwchange"),setTimeout(function(){a=!1},200))}).on("mouseup keydown keyup",function(){clearTimeout(n),n=setTimeout(function(){o.updateButtonPaneStatus()},50)}).on("focus blur",function(e){if(o.$c.trigger("tbw"+e.type),"blur"===e.type&&h("."+t+"active-button",o.$btnPane).removeClass(t+"active-button "+t+"active"),o.o.autogrowOnEnter){if(o.autogrowOnEnterDontClose)return;"focus"===e.type?(o.autogrowOnEnterWasFocused=!0,o.autogrowEditorOnEnter()):o.o.autogrow||(o.$ed.css({height:o.$ed.css("min-height")}),o.$c.trigger("tbwresize"))}}).on("cut",function(){setTimeout(function(){o.semanticCode(!1,!0),o.$c.trigger("tbwchange")},0)}).on("paste",function(n){if(o.o.removeformatPasted){n.preventDefault();try{var t=u.clipboardData.getData("Text");try{o.doc.selection.createRange().pasteHTML(t)}catch(e){o.doc.getSelection().getRangeAt(0).insertNode(o.doc.createTextNode(t))}o.$c.trigger("tbwchange",n)}catch(e){o.execCmd("insertText",(n.originalEvent||n).clipboardData.getData("text/plain"))}}h.each(o.pasteHandlers,function(e,t){t(n)}),setTimeout(function(){o.semanticCode(!1,!0),o.$c.trigger("tbwpaste",n)},0)}),o.$ta.on("keyup",function(){o.$c.trigger("tbwchange")}).on("paste",function(){setTimeout(function(){o.$c.trigger("tbwchange")},0)}),o.$box.on("keydown",function(e){return 27===e.which&&1===h("."+t+"modal-box",o.$box).length?(o.closeModal(),!1):void 0})},autogrowEditorOnEnter:function(){var e=this;e.$ed.removeClass("autogrow-on-enter");var t=e.$ed[0].clientHeight;e.$ed.height("auto");var n=e.$ed[0].scrollHeight;e.$ed.addClass("autogrow-on-enter"),t!==n&&(e.$ed.height(t),setTimeout(function(){e.$ed.css({height:n}),e.$c.trigger("tbwresize")},0))},buildBtnPane:function(){var a=this,r=a.o.prefix,i=a.$btnPane=h("<div/>",{class:r+"button-pane"});h.each(a.o.btns,function(e,t){try{var n=t.split("btnGrp-");null!=n[1]&&(t=a.o.btnsGrps[n[1]])}catch(e){}h.isArray(t)||(t=[t]);var o=h("<div/>",{class:r+"button-group "+(0<=t.indexOf("fullscreen")?r+"right":"")});h.each(t,function(e,t){try{var n;a.isSupportedBtn(t)&&(n=a.buildBtn(t)),o.append(n)}catch(e){}}),i.append(o)}),a.$box.prepend(i)},buildBtn:function(e){var n=this,t=n.o.prefix,o=n.btnsDef[e],a=o.dropdown,r=null==o.hasIcon||o.hasIcon,i=n.lang[e]||e,s=h("<button/>",{type:"button",class:t+e+"-button "+(o.class||"")+(r?"":" "+t+"textual-button"),html:n.hasSvg&&r?'<svg><use xlink:href="'+n.svgPath+"#"+t+(o.ico||e).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>':n.hideButtonTexts?"":o.text||o.title||n.lang[e]||e,title:(o.title||o.text||i)+(o.key?" (Ctrl + "+o.key+")":""),tabindex:-1,mousedown:function(){return(!a||h("."+e+"-"+t+"dropdown",n.$box).is(":hidden"))&&h("body",n.doc).trigger("mousedown"),(!n.$btnPane.hasClass(t+"disable")||h(this).hasClass(t+"active")||h(this).hasClass(t+"not-disable"))&&n.execCmd((!a?o.fn:"dropdown")||e,o.param||e,o.forceCss||!1),!1}});if(a){s.addClass(t+"open-dropdown");var l=t+"dropdown",d=h("<div/>",{class:l+"-"+e+" "+l+" "+t+"fixed-top","data-dropdown":e});h.each(a,function(e,t){n.btnsDef[t]&&n.isSupportedBtn(t)&&d.append(n.buildSubBtn(t))}),n.$box.append(d.hide())}else o.key&&(n.keys[o.key]={fn:o.fn||e,param:o.param||e});return a||(n.tagToButton[(o.tag||e).toLowerCase()]=e),s},buildSubBtn:function(e){var t=this,n=t.o.prefix,o=t.btnsDef[e],a=null==o.hasIcon||o.hasIcon;return o.key&&(t.keys[o.key]={fn:o.fn||e,param:o.param||e}),t.tagToButton[(o.tag||e).toLowerCase()]=e,h("<button/>",{type:"button",class:n+e+"-dropdown-button"+(o.ico?" "+n+o.ico+"-button":""),html:t.hasSvg&&a?'<svg><use xlink:href="'+t.svgPath+"#"+n+(o.ico||e).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>'+(o.text||o.title||t.lang[e]||e):o.text||o.title||t.lang[e]||e,title:o.key?" (Ctrl + "+o.key+")":null,style:o.style||null,mousedown:function(){return h("body",t.doc).trigger("mousedown"),t.execCmd(o.fn||e,o.param||e,o.forceCss||!1),!1}})},isSupportedBtn:function(e){try{return this.btnsDef[e].isSupported()}catch(e){}return!0},buildOverlay:function(){var e=this;return e.$overlay=h("<div/>",{class:e.o.prefix+"overlay"}).css({top:e.$btnPane.outerHeight(),height:e.$ed.outerHeight()+1+"px"}).appendTo(e.$box),e.$overlay},showOverlay:function(){h(u).trigger("scroll"),this.$overlay.fadeIn(200),this.$box.addClass(this.o.prefix+"box-blur")},hideOverlay:function(){this.$overlay.fadeOut(50),this.$box.removeClass(this.o.prefix+"box-blur")},fixedBtnPaneEvents:function(){var a=this,r=a.o.fixedFullWidth,i=a.$box;a.o.fixedBtnPane&&(a.isFixed=!1,h(u).on("scroll."+a.eventNamespace+" resize."+a.eventNamespace,function(){if(i){a.syncCode();var e=h(u).scrollTop(),t=i.offset().top+1,n=a.$btnPane,o=n.outerHeight()-2;0<e-t&&e-t-a.height<0?(a.isFixed||(a.isFixed=!0,n.css({position:"fixed",top:0,left:r?"0":"auto",zIndex:7}),h([a.$ta,a.$ed]).css({marginTop:n.height()})),n.css({width:r?"100%":i.width()-1+"px"}),h("."+a.o.prefix+"fixed-top",i).css({position:r?"fixed":"absolute",top:r?o:o+(e-t)+"px",zIndex:15})):a.isFixed&&(a.isFixed=!1,n.removeAttr("style"),h([a.$ta,a.$ed]).css({marginTop:0}),h("."+a.o.prefix+"fixed-top",i).css({position:"absolute",top:o}))}}))},toggleDisable:function(e){var t=this,n=t.o.prefix;(t.disabled=e)?t.$ta.attr("disabled",!0):t.$ta.removeAttr("disabled"),t.$box.toggleClass(n+"disabled",e),t.$ed.attr("contenteditable",!e)},destroy:function(){var e=this,t=e.o.prefix,n=e.height;e.isTextarea?e.$box.after(e.$ta.css({height:n}).val(e.html()).removeClass(t+"textarea").show()):e.$box.after(e.$ed.css({height:n}).removeClass(t+"editor").removeAttr("contenteditable").html(e.html()).show()),e.$ed.off("dblclick","img"),e.destroyPlugins(),e.$box.remove(),e.$c.removeData("trumbowyg"),h("body").removeClass(t+"body-fullscreen"),e.$c.trigger("tbwclose"),h(u).off("scroll."+e.eventNamespace+" resize."+e.eventNamespace)},empty:function(){this.$ta.val(""),this.syncCode(!0)},toggle:function(){var e=this,t=e.o.prefix;e.o.autogrowOnEnter&&(e.autogrowOnEnterDontClose=!e.$box.hasClass(t+"editor-hidden")),e.semanticCode(!1,!0),setTimeout(function(){e.doc.activeElement.blur(),e.$box.toggleClass(t+"editor-hidden "+t+"editor-visible"),e.$btnPane.toggleClass(t+"disable"),h("."+t+"viewHTML-button",e.$btnPane).toggleClass(t+"active"),e.$box.hasClass(t+"editor-visible")?e.$ta.attr("tabindex",-1):e.$ta.removeAttr("tabindex"),e.o.autogrowOnEnter&&!e.autogrowOnEnterDontClose&&e.autogrowEditorOnEnter()},0)},dropdown:function(e){var t=this,n=t.doc,o=t.o.prefix,a=h("[data-dropdown="+e+"]",t.$box),r=h("."+o+e+"-button",t.$btnPane),i=a.is(":hidden");if(h("body",n).trigger("mousedown"),i){var s=r.offset().left;r.addClass(o+"active"),a.css({position:"absolute",top:r.offset().top-t.$btnPane.offset().top+r.outerHeight(),left:t.o.fixedFullWidth&&t.isFixed?s+"px":s-t.$btnPane.offset().left+"px"}).show(),h(u).trigger("scroll"),h("body",n).on("mousedown."+t.eventNamespace,function(e){a.is(e.target)||(h("."+o+"dropdown",n).hide(),h("."+o+"active",n).removeClass(o+"active"),h("body",n).off("mousedown."+t.eventNamespace))})}},html:function(e){return null!=e?(this.$ta.val(e),this.syncCode(!0),this):this.$ta.val()},syncTextarea:function(){this.$ta.val(0<this.$ed.text().trim().length||0<this.$ed.find("hr,img,embed,iframe,input").length?this.$ed.html():"")},syncCode:function(e){var t=this;if(!e&&t.$ed.is(":visible"))t.syncTextarea();else{var n=h("<div>").html(t.$ta.val()),o=h("<div>").append(n);h(t.o.tagsToRemove.join(","),o).remove(),t.$ed.html(o.html())}if(t.o.autogrow&&(t.height=t.$ed.height(),t.height!==t.$ta.css("height")&&(t.$ta.css({height:t.height}),t.$c.trigger("tbwresize"))),t.o.autogrowOnEnter){t.$ed.height("auto");var a=t.autogrowOnEnterWasFocused?t.$ed[0].scrollHeight:t.$ed.css("min-height");a!==t.$ta.css("height")&&(t.$ed.css({height:a}),t.$c.trigger("tbwresize"))}},semanticCode:function(e,t,n){var o=this;if(o.saveRange(),o.syncCode(e),o.o.semantic){if(o.semanticTag("b","strong"),o.semanticTag("i","em"),t){var a=o.o.inlineElementsSelector,r=":not("+a+")";o.$ed.contents().filter(function(){return 3===this.nodeType&&0<this.nodeValue.trim().length}).wrap("<span data-tbw/>");var i=function(e){if(0!==e.length){var t=e.nextUntil(r).addBack().wrapAll("<p/>").parent(),n=t.nextAll(a).first();t.next("br").remove(),i(n)}};i(o.$ed.children(a).first()),o.semanticTag("div","p",!0),o.$ed.find("p").filter(function(){return(!o.range||this!==o.range.startContainer)&&(0===h(this).text().trim().length&&0===h(this).children().not("br,span").length)}).contents().unwrap(),h("[data-tbw]",o.$ed).contents().unwrap(),o.$ed.find("p:empty").remove()}n||o.restoreRange(),o.syncTextarea()}},semanticTag:function(e,t,n){h(e,this.$ed).each(function(){var e=h(this);e.wrap("<"+t+"/>"),n&&h.each(e.prop("attributes"),function(){e.parent().attr(this.name,this.value)}),e.contents().unwrap()})},createLink:function(){for(var e,t,n,o=this,a=o.doc.getSelection(),r=a.focusNode;["A","DIV"].indexOf(r.nodeName)<0;)r=r.parentNode;if(r&&"A"===r.nodeName){var i=h(r);e=i.attr("href"),t=i.attr("title"),n=i.attr("target");var s=o.doc.createRange();s.selectNode(r),a.removeAllRanges(),a.addRange(s)}o.saveRange(),o.openModalInsert(o.lang.createLink,{url:{label:"URL",required:!0,value:e},title:{label:o.lang.title,value:t},text:{label:o.lang.text,value:o.getRangeText()},target:{label:o.lang.target,value:n}},function(e){var t=h(['<a href="',e.url,'">',e.text,"</a>"].join(""));return 0<e.title.length&&t.attr("title",e.title),0<e.target.length&&t.attr("target",e.target),o.range.deleteContents(),o.range.insertNode(t[0]),!0})},unlink:function(){var e=this.doc.getSelection(),t=e.focusNode;if(e.isCollapsed){for(;["A","DIV"].indexOf(t.nodeName)<0;)t=t.parentNode;if(t&&"A"===t.nodeName){var n=this.doc.createRange();n.selectNode(t),e.removeAllRanges(),e.addRange(n)}}this.execCmd("unlink",void 0,void 0,!0)},insertImage:function(){var t=this;t.saveRange(),t.openModalInsert(t.lang.insertImage,{url:{label:"URL",required:!0},alt:{label:t.lang.description,value:t.getRangeText()}},function(e){return t.execCmd("insertImage",e.url),h('img[src="'+e.url+'"]:not([alt])',t.$box).attr("alt",e.alt),!0})},fullscreen:function(){var e,t=this.o.prefix,n=t+"fullscreen";this.$box.toggleClass(n),e=this.$box.hasClass(n),h("body").toggleClass(t+"body-fullscreen",e),h(u).trigger("scroll"),this.$c.trigger("tbw"+(e?"open":"close")+"fullscreen")},execCmd:function(t,n,e,o){var a=this;o=!!o||"","dropdown"!==t&&a.$ed.focus();try{a.doc.execCommand("styleWithCSS",!1,e||!1)}catch(e){}try{a[t+o](n)}catch(e){try{t(n)}catch(e){"insertHorizontalRule"===t?n=void 0:"formatBlock"===t&&a.isIE&&(n="<"+n+">"),a.doc.execCommand(t,!1,n),a.syncCode(),a.semanticCode(!1,!0)}"dropdown"!==t&&(a.updateButtonPaneStatus(),a.$c.trigger("tbwchange"))}},openModal:function(e,t){var n=this,o=n.o.prefix;if(0<h("."+o+"modal-box",n.$box).length)return!1;n.o.autogrowOnEnter&&(n.autogrowOnEnterDontClose=!0),n.saveRange(),n.showOverlay(),n.$overlay.css({height:n.$ed.outerHeight()+1+"px"}),n.$btnPane.addClass(o+"disable");var a=h("<div/>",{class:o+"modal "+o+"fixed-top"}).css({top:n.$btnPane.height()}).appendTo(n.$box);n.$overlay.one("click",function(){return a.trigger("tbwcancel"),!1});var r=h("<form/>",{action:"",html:t}).on("submit",function(){return a.trigger("tbwconfirm"),!1}).on("reset",function(){return a.trigger("tbwcancel"),!1}).on("submit reset",function(){n.o.autogrowOnEnter&&(n.autogrowOnEnterDontClose=!1)}),i=h("<div/>",{class:o+"modal-box",html:r}).css({top:"-"+n.$btnPane.outerHeight()+"px",opacity:0}).appendTo(a).animate({top:0,opacity:1},100);return h("<span/>",{text:e,class:o+"modal-title"}).prependTo(i),a.height(i.outerHeight()+10),h("input:first",i).focus(),n.buildModalBtn("submit",i),n.buildModalBtn("reset",i),h(u).trigger("scroll"),a},buildModalBtn:function(e,t){var n=this.o.prefix;return h("<button/>",{class:n+"modal-button "+n+"modal-"+e,type:e,text:this.lang[e]||e}).appendTo(h("form",t))},closeModal:function(){var e=this,t=e.o.prefix;e.$btnPane.removeClass(t+"disable"),e.$overlay.off();var n=h("."+t+"modal-box",e.$box);n.animate({top:"-"+n.height()},100,function(){n.parent().remove(),e.hideOverlay()}),e.restoreRange()},openModalInsert:function(e,t,n){var i=this,s=i.o.prefix,l=i.lang,d="",c="tbwconfirm";return h.each(t,function(e,t){var n=t.label,o=t.name||e,a=t.attributes||{},r=Object.keys(a).map(function(e){return e+'="'+a[e]+'"'}).join(" ");d+='<label><input type="'+(t.type||"text")+'" name="'+o+'" value="'+(t.value||"").replace(/"/g,"&quot;")+'"'+r+'><span class="'+s+'input-infos"><span>'+(n?l[n]?l[n]:n:l[e]?l[e]:e)+"</span></span></label>"}),i.openModal(e,d).on(c,function(){var o=h("form",h(this)),a=!0,r={};h.each(t,function(e,t){var n=h('input[name="'+e+'"]',o);"checkbox"===n.attr("type").toLowerCase()?r[e]=n.is(":checked"):r[e]=h.trim(n.val()),t.required&&""===r[e]?(a=!1,i.addErrorOnModalField(n,i.lang.required)):t.pattern&&!t.pattern.test(r[e])&&(a=!1,i.addErrorOnModalField(n,t.patternError))}),a&&(i.restoreRange(),n(r,t)&&(i.syncCode(),i.$c.trigger("tbwchange"),i.closeModal(),h(this).off(c)))}).one("tbwcancel",function(){h(this).off(c),i.closeModal()})},addErrorOnModalField:function(e,t){var n=this.o.prefix,o=e.parent();e.on("change keyup",function(){o.removeClass(n+"input-error")}),o.addClass(n+"input-error").find("input+span").append(h("<span/>",{class:n+"msg-error",text:t}))},saveRange:function(){var e=this,t=e.doc.getSelection();if(e.range=null,t.rangeCount){var n,o=e.range=t.getRangeAt(0),a=e.doc.createRange();a.selectNodeContents(e.$ed[0]),a.setEnd(o.startContainer,o.startOffset),n=(a+"").length,e.metaRange={start:n,end:n+(o+"").length}}},restoreRange:function(){var e,t=this,n=t.metaRange,o=t.range,a=t.doc.getSelection();if(o){if(n&&n.start!==n.end){var r,i=0,s=[t.$ed[0]],l=!1,d=!1;for(e=t.doc.createRange();!d&&(r=s.pop());)if(3===r.nodeType){var c=i+r.length;!l&&n.start>=i&&n.start<=c&&(e.setStart(r,n.start-i),l=!0),l&&n.end>=i&&n.end<=c&&(e.setEnd(r,n.end-i),d=!0),i=c}else for(var u=r.childNodes,g=u.length;0<g;)g-=1,s.push(u[g])}a.removeAllRanges(),a.addRange(e||o)}},getRangeText:function(){return this.range+""},updateButtonPaneStatus:function(){var r=this,i=r.o.prefix,e=r.getTagsRecursive(r.doc.getSelection().focusNode),s=i+"active-button "+i+"active";h("."+i+"active-button",r.$btnPane).removeClass(s),h.each(e,function(e,t){var n=r.tagToButton[t.toLowerCase()],o=h("."+i+n+"-button",r.$btnPane);if(0<o.length)o.addClass(s);else try{var a=(o=h("."+i+"dropdown ."+i+n+"-dropdown-button",r.$box)).parent().data("dropdown");h("."+i+a+"-button",r.$box).addClass(s)}catch(e){}})},getTagsRecursive:function(n,o){var a=this;if(o=o||(n&&n.tagName?[n.tagName]:[]),!n||!n.parentNode)return o;var e=(n=n.parentNode).tagName;return"DIV"===e?o:("P"===e&&""!==n.style.textAlign&&o.push(n.style.textAlign),h.each(a.tagHandlers,function(e,t){o=o.concat(t(n,a))}),o.push(e),a.getTagsRecursive(n,o))},initPlugins:function(){var n=this;n.loadedPlugins=[],h.each(h.trumbowyg.plugins,function(e,t){(!t.shouldInit||t.shouldInit(n))&&(t.init(n),t.tagHandler&&n.tagHandlers.push(t.tagHandler),n.loadedPlugins.push(t))})},destroyPlugins:function(){h.each(this.loadedPlugins,function(e,t){t.destroy&&t.destroy()})}}}(navigator,window,document,jQuery);